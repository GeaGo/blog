# 微服务架构及node后台框架搭建

## 微服务架构

在某味的工作就是调取各个微服务的接口，聚合数据来提供给前端。某味原本是一个php大厂，现在也算是其实，在业务扩张的情况下，选择微服务架构，每个业务部门单独服务提供接口，选择也很明智，但是遭遇了不仅仅是微服务构架都会遇到的问题，其微服务的稳定性和规范性也是有很多问题的。

我看到了一篇讨论微服务架构的十个问题的文章

> https://enpointer.com/blog/10-disadvantages-of-micro-services-architecture/

我决定在这里翻译一下，同时说一下我自己的感受：

生产中对于微服务架构有很多定义，但是有一个最普遍被接受的定义是，微服务架构是把大而复杂的系统拆分成通过api相互作用的小而模块化的组成的一种方式。

通过架构建立一个解耦的系统有很多很多的好处，开始出现一种工业标准来开始构建一整个分散解耦架构的系统，现在这种架构对于云基础应用十分好用。

当这种架构带来触手可及的好处时，同样也要注意这种架构的方式会带来一些不好的方面，要在系统架构和设计的一开始就需要去注意，如果你真的想要开始搭建一个解耦的系统，那么就有很多细微的方法需要你去理解。

有时，从一个单独的应用开始，随着系统的成长然后剥离不同的功能成为服务（比起直接开始一个微服务构架）更好，让我们看一下微服务架构的几个比较通常会出现的问题来帮你权衡选择：

1.难以维护。基于微服务的系统很难维持和重构，在一个单独的系统中，你只有一份代码去操作修改，但是在基于微服务的系统中，你有很多不同的代码去开发和维护

**这其实我觉得是微服务的双刃剑，每个team只要维护好自己服务的代码就好，提供好自己的服务，也就谈不上文章中说到的很多不同的代码，还是应该基于业务的实际情况来看待这个问题**

2.代码书写复杂。我们要承认，搭建一个解耦的系统不是一件小事，在代码聚合的接口要求你非常仔细计划设计系统，当调用一个服务失败的时候可能会成为一个问题，这时你需要写代码检查解决这种情况

**基本上和上一个问题一样，各部各司其职就好，分工明确也不是问题**

3.部署和系统管理十分痛苦。部署一个应用有时就已经很痛苦了，运维的小伙伴还要常常去解决运维问题。现在（微服务架构）又把这个问题扩大到和你有的微服务个数的倍数上，没有一个好的运维团队的话，基本上不可能构建和管理微服务架构的系统。

**环环相扣，运维的人员确实会比传统一个大项目需要的人多一些**

4.数据库管理。尽管可能你所有的服务只用一个数据库，但是你也需要十分复杂的逻辑和紧凑的代码来维持业务数据。每个服务可能需要有他们自己的数据库系统和他们联系起来，管理这么多小数据库会十分笨重，都会产生问题

**这一点在某味的时候也可以感受到两个服务方有各自的数据库，但是又有公共的数据在业务进行时又需要网关中间层调用双方的接口来保持数据统一，之后的数据操作也要留意。还有数据迁移困难，服务方业务转移，部分业务数据其他服务方接手，又不能使用同一个数据库，十分难操作**

5.需要更多的人力。微服务架构导致随着系统增长有很多moving parts（我的理解是类似于接口），也要去管理这些接合的moving parts，你需要一个相比起单独服务更多的人力。

**功能还是那些功能，但是需要一个中间层去把服务方接口再做成接口，确实需要更多的人力**

6.不同的技术栈。开始可能是有好处的，因为不必特指使用哪种技术栈，但是随着技术栈数量的增长，就需要有各种不同经验来管理他们。

**某味就是有php的服务方和java的服务方，有php是历史遗留，毕竟原来是个php大厂，有很多php转向java，新的服务也都是java在做，确实需要两套经验来搞定php和java。其次在工作的时候php的服务方给出的数据总是字符串类型，我也不懂php，php工程师和我说是因为弱类型语言导致的（可能吧，但是我总是觉得应该可以解决掉的**

7.追踪bug困难。追踪应用性能，管理日志，找bug会变得十分困难。在单一系统中，非常容易的追踪定位解决bug。

**显而易见，可以说是微服务比较大的几个痛点之一了，工作时，测试小伙伴验前端，发现接口或者数据有问题，就找到我，我又去检查接口，接口挂了就去找服务方，提供给我接口的服务方可能也调用其他服务方的接口，追踪起来人力时间都不小，才能去解决掉**

8.网络影响性能。由于微服务通过网络相互通信，系统的性能就依赖与网络的强度了。

**一开始进入美味的时候，我也有这样的存疑，靠http协议请求，会不会影响性能，研发经理和实际情况告诉我，网络的影响可以说是很小了，因为是几个服务器构成的内网，请求不同服务器的服务方，某些请求的时间非常少，还谈不上影响性能的层面**

9.改变接口是个复杂的事情。要让一个松耦合服务系统运行良好，每个api初始规范需要到位。尽管失败在这样的系统中是隔离的，但是改变api会对其余的功能产生一连串的影响。

**接口设计还是要符合开闭原则，修改要不影响之前的情况，但是这种单一功能接口要么不改，要么还是新写接口来为了新的功能把**

10.测试将成为一个挑战。测试一个单独的系统十分的简单，但是测试一个解耦基于服务的系统，意味着需要整个性能的展示，探索，功能和回归测试每一个独立的api。对于手动测试的测试工程师很难，建立一个适用于这样系统的自动化测试也是一个极大的挑战。

**某味的做法是只验最外的也就是前端的情况，对于服务方应该是没有测试，只靠开发人员自测，这肯定也会出现测试不到的部分，包括时间，状态等一系列影响因子，都上线很久了，有时会突然发现bug，也是微服务痛点**

最后一段是Enpointer平台的自我推荐，简单来说就是Enpointer支持微服务，微服务的优点远比上面提到的多，他们提供全套服务。

## node后台搭建

对于框架的选择，我个人还是比较倾向于选择express或者是koa，对于基于这两个再封装的框架，我还是不太喜欢，egg其实是一个很不错的框架，封装集成了很多东西，但是这次我还是准备基于两个最基础的的框架，做成starter kit。

typescript这两年是真的风头正盛，ts的好处也是确确实实的存在着才让ts这么火，所以这次的starter kit，我也决定加入ts

[express-starter-kit](https://github.com/GeaGo/express-starter-kit)
